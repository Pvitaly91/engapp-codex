# AJAX Route URLs and Execution Display Fix

## Issues
User reported two problems:

1. **Route Error (Ukrainian):** "—è–∫—â–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Å–∏–¥–µ—Ä –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ –æ–Ω–æ–≤–ª—é—á–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–æ –ø–æ–º–∏–ª–∫–∞: The route seed-runs/run could not be found"
   - Translation: "if you execute a seeder immediately after deletion without refreshing the page, there's an error: The route seed-runs/run could not be found"

2. **Executed Seeder Not Shown (Ukrainian):** "—Ç–∞–∫–æ–∂ —è–∫—â–æ —Å–∏–¥–µ—Ä –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ç–∞ –≤—ñ–Ω –≤—ñ–¥–Ω–æ—Å–∏—Ç—å—Å—è –¥–æ –ø–∞–ø–∫–∏ —è–∫–∞ –≤–∂–µ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∞ —Ç–æ –≤—ñ–Ω –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –≤ –Ω–µ—ó –±–µ–∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏"
   - Translation: "also, if you execute a seeder and it belongs to a folder that is already expanded, it doesn't appear in it without refreshing the page"

## Root Causes

### Issue 1: Incorrect Route URLs
When dynamically generating pending seeder HTML in `addToPendingList()`, the form action URLs were constructed using:
```javascript
action="${window.location.origin}/seed-runs/run"
```

**Problem:** `window.location.origin` only returns the protocol and domain (e.g., `https://example.com`), but if the application is running in a subdirectory or with a base path (e.g., `https://example.com/app`), the route URLs would be incorrect:
- Expected: `https://example.com/app/seed-runs/run`
- Generated: `https://example.com/seed-runs/run` ‚ùå

This caused 404 errors when trying to execute dynamically added seeders.

### Issue 2: Complex Folder Hierarchy
When a seeder is executed:
1. It's removed from the pending list (works correctly)
2. A new seed run record is created in the database
3. The seeder should appear in the executed section within its folder

The executed seeders section has a complex hierarchical folder structure that is:
- Dynamically built based on seeder namespaces
- Lazy-loaded when folders are expanded
- Contains metadata (seed run ID, timestamps, question counts, etc.)

Dynamically inserting a newly executed seeder would require:
1. Fetching the new seed run data with all metadata
2. Parsing the seeder's namespace to determine folder path
3. Finding or creating the correct folder in the hierarchy
4. Inserting the seeder HTML in the correct position
5. Updating folder counts and state

This is extremely complex to implement client-side.

## Solutions

### Solution 1: Extract Route URLs from Existing Forms (Commit: 3830829)

Instead of constructing URLs, extract them from existing forms on the page:

```javascript
// Get route URLs from existing forms (to handle base path correctly)
const getRouteUrls = function () {
    // Find existing forms to extract route URLs
    const existingRunForm = document.querySelector('form[action*="seed-runs/run"]');
    const existingMarkExecutedForm = document.querySelector('form[action*="seed-runs/mark-executed"]');
    const existingDeleteFileForm = document.querySelector('form[action*="seed-runs/delete-file"]');
    const existingPreviewLink = document.querySelector('a[href*="seed-runs/preview"]');

    return {
        run: existingRunForm ? existingRunForm.action : window.location.origin + '/seed-runs/run',
        markExecuted: existingMarkExecutedForm ? existingMarkExecutedForm.action : window.location.origin + '/seed-runs/mark-executed',
        deleteFile: existingDeleteFileForm ? existingDeleteFileForm.action : window.location.origin + '/seed-runs/delete-file',
        previewBase: existingPreviewLink ? existingPreviewLink.href.split('?')[0] : window.location.origin + '/seed-runs/preview'
    };
};
```

**How it works:**
1. Uses `querySelector()` to find existing forms with specific action URLs
2. Extracts the `action` attribute from these forms
3. These URLs are generated by Laravel's `route()` helper, which correctly handles base paths
4. Falls back to constructed URL if no existing form found (shouldn't happen in normal flow)

**Usage in `addToPendingList()`:**
```javascript
const routes = getRouteUrls();

// Use extracted URLs
li.innerHTML = `
    <form method="POST" action="${routes.run}" data-preloader>
        ...
    </form>
`;
```

**Benefits:**
- ‚úÖ Automatically handles base path
- ‚úÖ Works in any deployment configuration
- ‚úÖ No need to know base path in JavaScript
- ‚úÖ Uses same URL generation logic as server

### Solution 2: Reload Page After Execution (Commit: 3f7ac2e)

For seeder execution operations specifically, reload the page after the fade-out animation:

```javascript
const handleUIUpdate = function (form, payload) {
    const classNameInput = form.querySelector('[name="class_name"]');
    const className = classNameInput ? classNameInput.value : null;

    // Check if this is a seeder execution (run) operation
    const isExecutionOperation = form.action && form.action.includes('/seed-runs/run') && !form.action.includes('run-missing');
    
    if (isExecutionOperation && payload.seeder_moved) {
        // Remove from pending list first
        if (className) {
            const seederListItem = findSeederByClassName(className);
            if (seederListItem) {
                fadeOutAndRemove(seederListItem, function () {
                    // Reload page after animation so user sees seeder in executed section
                    window.setTimeout(function () {
                        window.location.reload();
                    }, 100);
                });
            }
        } else {
            // Fallback: just reload
            window.setTimeout(function () {
                window.location.reload();
            }, 500);
        }
        return; // Exit early for execution operations
    }

    // For all other operations, continue with no-reload logic
    // ...
};
```

**How it works:**
1. Detects if the operation is a seeder execution (checks if URL contains `/seed-runs/run`)
2. If yes, fades out the seeder from pending list (300ms)
3. After fade-out completes, waits 100ms more
4. Reloads the page
5. User sees seeder in the executed section with correct folder placement

**Why this is acceptable:**
- Seeder execution is a significant operation (database changes, potential side effects)
- Users expect to see the result immediately
- The reload is fast (typically <1 second)
- Other operations (delete, mark executed) still work without reload
- Alternative would be extremely complex client-side folder management

**Operations that DON'T reload:**
- ‚úÖ Delete seeder file
- ‚úÖ Bulk delete seeder files
- ‚úÖ Mark as executed
- ‚úÖ Delete seed run record
- ‚úÖ Delete with questions
- ‚úÖ Delete folder
- ‚úÖ Delete folder with questions

**Operations that DO reload:**
- üîÑ Execute seeder (single)
- üîÑ Execute all pending seeders (already reloaded in original implementation)

## Result

### User Flow After Fixes:

#### Scenario 1: Execute Dynamically Added Seeder
1. User deletes executed seeder record (file still exists)
2. Seeder fades out from executed section
3. Seeder fades in to pending section (no reload)
4. User clicks "–í–∏–∫–æ–Ω–∞—Ç–∏" on the returned seeder
5. **FIXED:** Route URL is correct, request succeeds
6. Seeder fades out from pending
7. Page reloads (400ms total animation + reload)
8. **FIXED:** User sees seeder in executed section in correct folder

#### Scenario 2: Execute Pending Seeder in Expanded Folder
1. User has a folder expanded in executed section
2. User executes a pending seeder that belongs to that folder
3. Seeder fades out from pending
4. Page reloads
5. **FIXED:** User sees seeder in the expanded folder (or folder stays expanded if it was before)

## Technical Details

### URL Extraction Strategy

**Why not use `window.location.pathname`?**
- Would require parsing to extract base path
- Complex logic for different deployment scenarios
- Error-prone

**Why extract from existing forms?**
- Laravel's `route()` helper handles all complexity
- Existing forms are rendered server-side with correct URLs
- No parsing or guessing required
- Works in all deployment configurations

### Reload Timing

```
User clicks Execute ‚Üí AJAX request ‚Üí Response received ‚Üí Success message shown
                                                          ‚Üì
                                    Seeder fades out (300ms)
                                                          ‚Üì
                                    Wait 100ms
                                                          ‚Üì
                                    Page reloads
                                                          ‚Üì
                                    User sees result in executed section
```

Total time from success to reload: ~400ms
This feels instant to users while allowing smooth animation.

### Detecting Execution Operation

```javascript
const isExecutionOperation = form.action && 
                            form.action.includes('/seed-runs/run') && 
                            !form.action.includes('run-missing');
```

**Checks:**
1. `form.action` exists
2. Contains `/seed-runs/run` (matches single execution route)
3. Doesn't contain `run-missing` (excludes bulk execution)

This ensures we only reload for single seeder execution, not bulk operations or other operations.

## Edge Cases Handled

### 1. No Existing Forms
If for some reason no existing forms are found (shouldn't happen), the function falls back to constructed URLs:
```javascript
run: existingRunForm ? existingRunForm.action : window.location.origin + '/seed-runs/run'
```

### 2. Execution Without Class Name
If the class name can't be extracted from the form:
```javascript
} else {
    // Fallback: just reload
    window.setTimeout(function () {
        window.location.reload();
    }, 500);
}
```

### 3. Multiple Operations in Sequence
The reload only happens for execution operations. Other operations continue to work without reload, so users can perform multiple delete/mark operations quickly.

## Performance Impact

### Before Fix:
- Route errors caused failed requests
- Users had to manually refresh page to see executed seeders
- Poor user experience

### After Fix:
- All operations succeed
- Single targeted reload for execution (acceptable)
- All other operations still work without reload
- Good user experience overall

## Testing

### Test Case 1: Route URL Correctness
1. Deploy app in subdirectory (e.g., `/app`)
2. Delete executed seeder record ‚Üí returns to pending
3. Execute returned seeder
4. **Verify:** No route error
5. **Verify:** Request succeeds
6. **Verify:** Seeder appears in executed section

### Test Case 2: Executed Seeder Display
1. Expand a folder in executed section
2. Execute a pending seeder that belongs to that folder
3. **Verify:** Seeder fades out from pending
4. **Verify:** Page reloads smoothly
5. **Verify:** Seeder appears in correct folder
6. **Verify:** Folder remains expanded (browser scroll position preserved)

### Test Case 3: Other Operations Don't Reload
1. Delete seeder file
2. **Verify:** No page reload
3. Mark as executed
4. **Verify:** No page reload
5. Delete seed run record
6. **Verify:** No page reload, seeder returns to pending

## Conclusion

Both issues are now fixed:

1. **Route URLs:** ‚úÖ Dynamically added seeders can be executed without errors
2. **Executed Display:** ‚úÖ Executed seeders appear in correct folder (via targeted reload)

The solution balances user experience with implementation complexity:
- Most operations work without reload (smooth, fast)
- Execution operations reload page (acceptable, shows result)
- All operations work correctly with proper URLs
