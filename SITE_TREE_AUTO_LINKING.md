# Автоматичне зв'язування елементів дерева сайту з сторінками

## Опис функціональності

Система автоматичного зв'язування дозволяє автоматично створювати зв'язки між елементами дерева сайту (в `/admin/site-tree`) та існуючими теоретичними сторінками.

## Стратегії пошуку відповідностей

Система використовує кілька стратегій для пошуку відповідностей між елементами дерева та сторінками:

### 1. Точна відповідність за назвою
Перевіряється точна відповідність назви елемента дерева з назвою сторінки.

### 2. Відповідність без нумерації
Видаляється нумерація типу "1." або "1.2" з назви та перевіряється відповідність.

**Приклад:**
- Елемент дерева: "1. Базова граматика"
- Шукається: "Базова граматика"

### 3. Нечітка відповідність (Fuzzy Matching)
Перевіряється, чи одна назва містить іншу (без урахування регістру).

**Приклад:**
- Елемент дерева: "Word Order — Порядок слів"
- Сторінка: "Word Order"
- Результат: знайдено відповідність

### 4. Відповідність за класом seeder
Якщо у сторінки є поле `seeder`, система перевіряє, чи назва класу seeder містить слова з назви елемента дерева.

**Приклад:**
- Елемент дерева: "Advanced Word Order Emphasis"
- Seeder: `AdvancedWordOrderEmphasisTheorySeeder`
- Результат: знайдено відповідність

## Використання

### Через веб-інтерфейс (рекомендовано)

1. Відкрийте `/admin/site-tree`
2. Натисніть кнопку "Зв'язати сторінки" (фіолетова кнопка з іконкою зв'язку)
3. Підтвердіть дію в діалоговому вікні
4. Система автоматично:
   - Знайде відповідності між елементами дерева та сторінками
   - Створить нові зв'язки
   - Оновить існуючі зв'язки
5. З'явиться повідомлення з кількістю створених та оновлених зв'язків

### Через команду Artisan

Альтернативно, можна використати команду Artisan:

```bash
php artisan site-tree:link-pages
```

Для конкретного варіанта дерева:

```bash
php artisan site-tree:link-pages --variant-id=1
```

## Що змінюється

Після виконання автоматичного зв'язування:

1. Поле `linked_page_title` в `site_tree_items` заповнюється назвою знайденої сторінки
2. Поле `linked_page_url` заповнюється URL-адресою сторінки
3. У веб-інтерфейсі зв'язані елементи відображаються з зеленим фоном та мають клікабельне посилання

## Приклади відповідностей

| Елемент дерева | Знайдена сторінка | Стратегія |
|----------------|-------------------|-----------|
| "1. Базова граматика" | "Базова граматика" | Без нумерації |
| "Word Order — Порядок слів" | "Word Order — Порядок слів" | Точна відповідність |
| "Advanced word order and emphasis" | "Advanced Word Order and Emphasis — Інверсія та підсилення" | Нечітка відповідність |
| "Imperatives" | "Imperatives — наказові речення" | Нечітка відповідність |

## Технічні деталі

### Файли, що задіяні:

- **Service**: `app/Services/SiteTreeLinkingService.php` - основна логіка зв'язування
- **Controller**: `app/Http/Controllers/SiteTreeController.php` - метод `linkToPages()`
- **Route**: `routes/web.php` - `POST /admin/site-tree/link-pages`
- **View**: `resources/views/admin/site-tree/index.blade.php`
- **Artisan Command**: `app/Console/Commands/LinkSiteTreeItemsToPages.php`

### Моделі:

- `App\Models\SiteTreeItem` - елементи дерева сайту
- `App\Models\Page` - теоретичні сторінки
- `App\Models\PageCategory` - категорії сторінок

### Поля в базі даних:

Таблиця `site_tree_items`:
- `linked_page_title` (nullable) - назва зв'язаної сторінки
- `linked_page_url` (nullable) - URL зв'язаної сторінки

Таблиця `pages`:
- `seeder` (nullable) - повна назва класу seeder

## Логіка роботи

```php
// Використовує SiteTreeLinkingService
$linkingService = new \App\Services\SiteTreeLinkingService();

// 1. Отримати всі сторінки з URL
$pagesWithUrls = $linkingService->getPageUrlMap();

// 2. Для кожного елемента дерева
foreach ($items as $item) {
    // 3. Знайти відповідну сторінку (4 стратегії)
    $match = $linkingService->findPageMatch($item->title, $pagesWithUrls);
    
    // 4. Якщо знайдено, оновити зв'язок
    if ($match) {
        $item->update([
            'linked_page_title' => $match['title'],
            'linked_page_url' => $match['url'],
        ]);
    }
}

// 5. Повернути статистику
return [
    'linked' => $linkedCount,    // Нових зв'язків
    'updated' => $updatedCount,  // Оновлених зв'язків
    'skipped' => $skippedCount,  // Без відповідностей
];
```

## Обмеження

- Працює тільки зі сторінками типу `theory`
- Не видаляє існуючі зв'язки, тільки оновлює їх
- Якщо для елемента не знайдено відповідності, він залишається без змін

## Поради

1. **Спочатку налаштуйте seeders**: Переконайтеся, що у всіх сторінок правильно заповнене поле `seeder`
2. **Перевірте назви**: Після автоматичного зв'язування перевірте створені зв'язки в UI
3. **Ручне коригування**: Якщо автоматика не знайшла відповідність або знайшла неправильну, використовуйте кнопку "Зв'язати з /theory" для ручного зв'язування
4. **Регулярне оновлення**: Виконуйте автоматичне зв'язування після додавання нових сторінок або зміни структури дерева

## Відладка

Якщо зв'язки створюються неправильно:

1. Перевірте назви елементів дерева та сторінок
2. Переконайтеся, що сторінки мають тип `theory`
3. Перевірте, чи правильно заповнене поле `seeder` у сторінок
4. Перегляньте логи Laravel для деталей помилок

## Майбутні покращення

- [ ] Додати можливість вибору стратегії пошуку
- [ ] Зберігати історію зв'язків
- [ ] Додати preview перед застосуванням змін
- [ ] Покращити алгоритм fuzzy matching
- [ ] Додати можливість відміни останнього зв'язування
