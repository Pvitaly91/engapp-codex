# Автоматичне зв'язування елементів дерева сайту з сторінками

## Опис функціональності

Система автоматичного зв'язування дозволяє автоматично створювати зв'язки між елементами дерева сайту (в `/admin/site-tree`) та існуючими теоретичними сторінками **на основі поля seeder**.

## Як працює

Система зв'язує елементи дерева з сторінками/категоріями **виключно через поле `seeder`** в таблицях `pages` та `page_categories`.

### Алгоритм роботи:

1. **Очищення старих зв'язків** - видаляються всі існуючі значення `linked_page_url` та `linked_page_title`
2. **Пошук за seeder полем** - система шукає сторінки/категорії, у яких поле `seeder` містить назву класу, що відповідає елементу дерева
3. **Створення нових зв'язків** - встановлюються нові зв'язки на основі знайдених відповідностей

### Приклад відповідності за seeder:

**Елемент дерева:** "Word Order — Порядок слів"

**Seeder клас:** `Database\Seeders\Page_v2\BasicGrammar\WordOrder\00_WordOrderCategorySeeder`

**Результат:** Знайдено відповідність ✓

Система:
1. Бере назву елемента: "Word Order — Порядок слів"
2. Витягує англійську частину: "Word Order"
3. Перетворює на паттерн: "WordOrder"
4. Шукає у назвах seeder-класів: `WordOrderCategorySeeder` ✓

## Використання

### Через веб-інтерфейс (рекомендовано)

1. Відкрийте `/admin/site-tree`
2. Натисніть кнопку "Зв'язати сторінки" (фіолетова кнопка з іконкою зв'язку)
3. Підтвердіть дію в діалоговому вікні
4. Система автоматично:
   - Очистить всі старі зв'язки
   - Знайде відповідності за seeder полем
   - Створить нові зв'язки
5. З'явиться повідомлення з результатом роботи

### Через команду Artisan

Альтернативно, можна використати команду Artisan:

```bash
php artisan site-tree:link-pages
```

Для конкретного варіанта дерева:

```bash
php artisan site-tree:link-pages --variant-id=1
```

## Що змінюється

Після виконання автоматичного зв'язування:

1. **Спочатку очищаються** всі старі значення `linked_page_title` та `linked_page_url` для всіх елементів
2. Поле `linked_page_title` заповнюється назвою знайденої сторінки/категорії (тільки якщо є відповідність за seeder)
3. Поле `linked_page_url` заповнюється URL-адресою (тільки якщо є відповідність за seeder)
4. У веб-інтерфейсі зв'язані елементи відображаються з зеленим фоном та мають клікабельне посилання

## Приклади відповідностей

| Елемент дерева | Seeder клас | Результат |
|----------------|-------------|-----------|
| "1. Базова граматика" | `BasicGrammarCategoryV2Seeder` | ✓ Знайдено |
| "Word Order — Порядок слів" | `WordOrderCategorySeeder` | ✓ Знайдено |
| "Advanced word order and emphasis" | `AdvancedWordOrderEmphasisTheorySeeder` | ✓ Знайдено |
| "Imperatives" | `BasicGrammarImperativesTheorySeeder` | ✓ Знайдено |
| "Some random text" | (немає seeder) | ✗ Не знайдено |

## Технічні деталі

### Файли, що задіяні:

- **Service**: `app/Services/SiteTreeLinkingService.php` - основна логіка зв'язування
- **Controller**: `app/Http/Controllers/SiteTreeController.php` - метод `linkToPages()`
- **Route**: `routes/web.php` - `POST /admin/site-tree/link-pages`
- **View**: `resources/views/admin/site-tree/index.blade.php`
- **Artisan Command**: `app/Console/Commands/LinkSiteTreeItemsToPages.php`

### Моделі:

- `App\Models\SiteTreeItem` - елементи дерева сайту
- `App\Models\Page` - теоретичні сторінки
- `App\Models\PageCategory` - категорії сторінок

### Поля в базі даних:

Таблиця `site_tree_items`:
- `linked_page_title` (nullable) - назва зв'язаної сторінки
- `linked_page_url` (nullable) - URL зв'язаної сторінки

Таблиця `pages`:
- `seeder` (nullable) - повна назва класу seeder

## Логіка роботи

```php
// Використовує SiteTreeLinkingService
$linkingService = new SiteTreeLinkingService();

// 1. Очистити всі старі зв'язки
foreach ($items as $item) {
    $item->update([
        'linked_page_title' => null,
        'linked_page_url' => null,
    ]);
}

// 2. Отримати карту seeder-класів
$seederMap = $linkingService->buildSeederMap();
// Карта: ['SeederClassName' => ['title' => '...', 'url' => '...']]

// 3. Для кожного елемента дерева
foreach ($items as $item) {
    // 4. Знайти відповідність ТІЛЬКИ за seeder полем
    $match = $linkingService->findPageBySeeder($item->title, $seederMap);
    
    // 5. Якщо знайдено, встановити новий зв'язок
    if ($match) {
        $item->update([
            'linked_page_title' => $match['title'],
            'linked_page_url' => $match['url'],
        ]);
    }
}

// 6. Повернути статистику
return [
    'cleared' => $clearedCount,  // Очищених зв'язків
    'linked' => $linkedCount,    // Нових зв'язків
    'skipped' => $skippedCount,  // Без відповідностей
];
```

## Обмеження

- Працює **тільки** зі сторінками типу `theory`
- Працює **тільки** зі сторінками/категоріями, які мають заповнене поле `seeder`
- **Спочатку видаляє всі існуючі зв'язки**, потім створює нові
- Якщо для елемента не знайдено відповідності за seeder, він залишається без зв'язку

## Поради

1. **Спочатку налаштуйте seeders**: Переконайтеся, що у всіх сторінок правильно заповнене поле `seeder`
2. **Перевірте назви**: Після автоматичного зв'язування перевірте створені зв'язки в UI
3. **Ручне коригування**: Якщо автоматика не знайшла відповідність або знайшла неправильну, використовуйте кнопку "Зв'язати з /theory" для ручного зв'язування
4. **Регулярне оновлення**: Виконуйте автоматичне зв'язування після додавання нових сторінок або зміни структури дерева

## Відладка

Якщо зв'язки створюються неправильно:

1. Перевірте назви елементів дерева та сторінок
2. Переконайтеся, що сторінки мають тип `theory`
3. Перевірте, чи правильно заповнене поле `seeder` у сторінок
4. Перегляньте логи Laravel для деталей помилок

## Майбутні покращення

- [ ] Додати можливість вибору стратегії пошуку
- [ ] Зберігати історію зв'язків
- [ ] Додати preview перед застосуванням змін
- [ ] Покращити алгоритм fuzzy matching
- [ ] Додати можливість відміни останнього зв'язування
