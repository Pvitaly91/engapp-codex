# Auto-Generated Tests Feature

## Overview

This feature automatically generates tests for theory pages and categories based on AI-generated questions (flag=2) that match the page/category tags.

## Features

### 1. Automatic Test Generation
- Generates **5 tests** for each page or category
- Each test targets a specific level pair:
  - A1-A2
  - A2-B1
  - B1-B2
  - B2-C1
  - C1-C2

### 2. Smart Question Filtering
Questions are filtered by:
- **flag=2**: Only AI-generated questions (flag=2)
- **Tags**: Questions must have at least one tag matching the page/category
- **Level**: Questions must be at the appropriate level for the test (e.g., A1 or A2 for the A1-A2 test)

### 3. Test Structure
- Each test contains **15 questions**
- Questions are **shuffled** on each generation
- Tests only appear if there are enough questions (≥15) for the level pair

### 4. Random Questions on Each Visit
- Questions are selected randomly using `inRandomOrder()`
- The `randomize_filtered` option ensures different questions each time the test is taken
- This provides variety and prevents memorization

## Usage

### For End Users

1. **Navigate to a theory page or category**
   - Go to any theory page (e.g., `/pages/{category}/{page}`)
   - Or go to a category page (e.g., `/pages/{category}`)

2. **Find the "Згенеровані тести" (Generated Tests) section**
   - This section appears below the page content
   - It shows cards for available auto-generated tests

3. **Select a test**
   - Click on a test card to start the test
   - Each card shows:
     - Level range (e.g., "A1-A2")
     - Number of questions available
     - Tags associated with the test

4. **Take the test**
   - Complete the 15 questions
   - Submit your answers for checking

### For Developers

#### Service: AutoGeneratedTestService

Located at: `app/Services/AutoGeneratedTestService.php`

**Main Method: `generateTests(Collection $tags, string $contextPrefix = '')`**

```php
$autoGeneratedTests = $this->autoGeneratedTestService->generateTests($page->tags, $page->title);
```

Returns a collection of SavedGrammarTest models:
```php
// Each test is a SavedGrammarTest model with:
// - slug: unique identifier for the test
// - name: display name (e.g., "Page Title: Тест A1-A2")
// - filters: array with test configuration
// - total_questions_available: computed attribute with question count
]
```

#### Controller: PageController

The `category()` and `show()` methods have been updated to:
1. Generate auto-tests using the service
2. Pass the tests to the view

```php
$autoGeneratedTests = $this->autoGeneratedTestService->generateTests($page->tags);

return view('engram.pages.show', [
    // ... other data
    'autoGeneratedTests' => $autoGeneratedTests,
]);
```

#### Routes

Auto-generated tests use the existing saved test route:

```php
Route::get('/test/{slug}/js', [GrammarTestController::class, 'showSavedTestJs'])
    ->name('saved-test.js');
```

The `AutoGeneratedTestService` creates `SavedGrammarTest` records that can be accessed via this route.

#### Views

**Component: `auto-generated-test-card.blade.php`**
- Displays a card for each auto-generated test
- Shows level information, question count, and tags
- Links to `/test/{slug}/js` route

**Updated Views:**
- `engram/pages/show.blade.php`: Added auto-generated tests section
- `engram/pages/index.blade.php`: Added auto-generated tests section

## Technical Details

### Test Generation Algorithm

1. Build a query filtering by:
   - `flag = 2` (AI-generated questions)
   - `level IN [levelFrom, levelTo]`
   - Has at least one matching tag

2. Count total available questions

3. If count < 15, skip this level pair

4. Create or retrieve SavedGrammarTest with:
   - Unique slug based on context + levels + tag hash
   - Filter-based mode (`__meta.mode = 'filters'`)
   - Filters defining question selection

5. Add computed attribute `total_questions_available` to model

### Test Persistence

- Tests are stored as `SavedGrammarTest` records in the database
- Each test has a unique slug generated from:
  - Context prefix (page/category title)
  - Level pair (e.g., "a1-a2")
  - Tag hash (8-character MD5)
- Tests are reused across page visits (no duplicates created)
- Filter-based mode ensures questions are selected dynamically on each test run

### Randomization

Questions are randomized using filter-based selection:

1. **Test Creation**: Service stores filters, not specific question UUIDs
2. **Test Execution**: Each test run queries questions matching filters with `randomize_filtered: true`
3. **Result**: Different random questions on every test attempt

This provides maximum variety and prevents memorization.

### Performance Considerations

- Tests are created/retrieved once per page load
- Question counts computed during test generation (no N+1 queries)
- Actual questions loaded only when user starts the test
- Filter-based mode allows dynamic question selection without storing question lists

## Testing

Unit tests are located at: `tests/Unit/AutoGeneratedTestServiceTest.php`

Tests cover:
- Empty tag collection handling
- SavedGrammarTest model creation
- Test generation with sufficient questions
- Skipping level pairs with insufficient questions
- Flag filtering (only flag=2 questions)
- Test reuse with same slug (no duplicates)

Run tests with:
```bash
php artisan test tests/Unit/AutoGeneratedTestServiceTest.php
```

## Future Enhancements

Potential improvements:
1. Cache test metadata to improve performance
2. Add difficulty filtering within level pairs
3. Allow users to save favorite auto-generated tests
4. Show test statistics (average score, completion rate, etc.)
5. Add more level combinations based on user preferences
