# Auto-Generated Tests Feature

## Overview

This feature automatically generates tests for theory pages and categories based on AI-generated questions (flag=2) that match the page/category tags.

## Features

### 1. Automatic Test Generation
- Generates **5 tests** for each page or category
- Each test targets a specific level pair:
  - A1-A2
  - A2-B1
  - B1-B2
  - B2-C1
  - C1-C2

### 2. Smart Question Filtering
Questions are filtered by:
- **flag=2**: Only AI-generated questions (flag=2)
- **Tags**: Questions must have at least one tag matching the page/category
- **Level**: Questions must be at the appropriate level for the test (e.g., A1 or A2 for the A1-A2 test)

### 3. Test Structure
- Each test contains **15 questions**
- Questions are **shuffled** on each generation
- Tests only appear if there are enough questions (≥15) for the level pair

### 4. Random Questions on Each Visit
- Questions are selected randomly using `inRandomOrder()`
- The `randomize_filtered` option ensures different questions each time the test is taken
- This provides variety and prevents memorization

## Usage

### For End Users

1. **Navigate to a theory page or category**
   - Go to any theory page (e.g., `/pages/{category}/{page}`)
   - Or go to a category page (e.g., `/pages/{category}`)

2. **Find the "Згенеровані тести" (Generated Tests) section**
   - This section appears below the page content
   - It shows cards for available auto-generated tests

3. **Select a test**
   - Click on a test card to start the test
   - Each card shows:
     - Level range (e.g., "A1-A2")
     - Number of questions available
     - Tags associated with the test

4. **Take the test**
   - Complete the 15 questions
   - Submit your answers for checking

### For Developers

#### Service: AutoGeneratedTestService

Located at: `app/Services/AutoGeneratedTestService.php`

**Main Method: `generateTests(Collection $tags)`**

```php
$autoGeneratedTests = $this->autoGeneratedTestService->generateTests($page->tags);
```

Returns a collection of test data arrays:
```php
[
    [
        'level_from' => 'A1',
        'level_to' => 'A2',
        'level_label' => 'A1-A2',
        'questions_count' => 15,
        'total_available' => 45,
        'question_uuids' => [...],
    ],
    // ... up to 5 tests
]
```

#### Controller: PageController

The `category()` and `show()` methods have been updated to:
1. Generate auto-tests using the service
2. Pass the tests to the view

```php
$autoGeneratedTests = $this->autoGeneratedTestService->generateTests($page->tags);

return view('engram.pages.show', [
    // ... other data
    'autoGeneratedTests' => $autoGeneratedTests,
]);
```

#### Controller: GrammarTestController

New method `showAutoGeneratedTest(Request $request)` handles displaying the test:

```php
Route::get('/auto-test', [GrammarTestController::class, 'showAutoGeneratedTest'])
    ->name('auto-test.show');
```

Query parameters:
- `level_from`: Starting level (e.g., 'A1')
- `level_to`: Ending level (e.g., 'A2')
- `tags[]`: Array of tag names

#### Views

**Component: `auto-generated-test-card.blade.php`**
- Displays a card for each auto-generated test
- Shows level information, question count, and tags
- Links to the test

**View: `auto-generated-test.blade.php`**
- Main test view
- Shows the 15 questions
- Handles test submission

**Updated Views:**
- `engram/pages/show.blade.php`: Added auto-generated tests section
- `engram/pages/index.blade.php`: Added auto-generated tests section

## Technical Details

### Question Selection Algorithm

1. Build a query filtering by:
   - `flag = 2` (AI-generated questions)
   - `level IN [levelFrom, levelTo]`
   - Has at least one matching tag

2. Count total available questions

3. If count < 15, skip this level pair

4. Select 15 random questions using `inRandomOrder()->limit(15)`

### Randomization

The feature uses two levels of randomization:

1. **Test Generation Time**: Questions are selected randomly when the page loads
2. **Test Taking Time**: Questions are selected randomly when the user clicks to take the test

This ensures maximum variety and prevents memorization.

### Performance Considerations

- Questions are not pre-loaded on page view
- Only test metadata (count, level, etc.) is generated
- Actual questions are loaded only when the user starts the test
- This keeps page load times fast

## Testing

Unit tests are located at: `tests/Unit/AutoGeneratedTestServiceTest.php`

Tests cover:
- Empty tag collection handling
- Test generation with sufficient questions
- Skipping level pairs with insufficient questions
- Flag filtering (only flag=2 questions)
- Filter building

Run tests with:
```bash
php artisan test tests/Unit/AutoGeneratedTestServiceTest.php
```

## Future Enhancements

Potential improvements:
1. Cache test metadata to improve performance
2. Add difficulty filtering within level pairs
3. Allow users to save favorite auto-generated tests
4. Show test statistics (average score, completion rate, etc.)
5. Add more level combinations based on user preferences
