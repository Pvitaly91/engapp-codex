# FLOWS.md — Користувацькі потоки

## 1. Глобальний пошук → Відкриття теорії/тесту

### Кроки користувача
1. Користувач вводить текст у поле пошуку (header)
2. JS відправляє GET запит на `/search?q={query}`
3. Отримує JSON з результатами (pages, tests)
4. Dropdown показує результати з типом (page/test)
5. Користувач клікає на результат
6. Перехід на сторінку теорії або тесту

### Задіяні файли
| Тип | Файл |
|-----|------|
| Controller | `app/Http/Controllers/SiteSearchController.php` |
| Model | `app/Models/Page.php`, `app/Models/Test.php` |
| View | `resources/views/search/results.blade.php` |
| JS | Inline в layout (компонент пошуку) |

### Код flow
```php
// SiteSearchController.php
$pages = Page::query()
    ->where('title', 'like', "%{$query}%")
    ->limit(10)->get();

$tests = Test::query()
    ->where('name', 'like', "%{$query}%")
    ->limit(10)->get();

return response()->json($pages->concat($tests));
```

---

## 2. Каталог → Старт тесту → Результати

### Кроки користувача
1. Користувач відкриває `/catalog/tests-cards`
2. Бачить картки тестів, згруповані за категоріями
3. Клікає на тест → переходить на `/test/{slug}`
4. JavaScript ініціалізує тест з питаннями
5. Користувач відповідає на питання (select/input/manual)
6. JS перевіряє відповідь локально (client-side)
7. Показується результат: правильно/неправильно
8. Після всіх питань — фінальний score

### Задіяні файли
| Тип | Файл |
|-----|------|
| Controller | `app/Http/Controllers/GrammarTestController.php` (catalog) |
| Controller | `app/Http/Controllers/TestJsV2Controller.php` (test view) |
| Model | `app/Models/SavedGrammarTest.php` |
| Model | `app/Models/Question.php`, `QuestionAnswer.php` |
| View | `resources/views/tests/saved-test-js-v2.blade.php` |
| Service | `app/Services/SavedTestResolver.php` |
| Service | `app/Services/QuestionVariantService.php` |

### Режими тесту
- **Card mode** (`/test/{slug}`) — всі питання на одній сторінці
- **Step mode** (`/test/{slug}/step`) — одне питання за раз
- **Input/Select/Manual** — спосіб введення відповіді

---

## 3. Теорія → Навігація по розділах/тегах

### Кроки користувача
1. Користувач відкриває `/theory`
2. Бачить список категорій (sidebar) та сторінок
3. Клікає на категорію → `/theory/{category}`
4. Бачить список сторінок категорії + пов'язані тести
5. Клікає на сторінку → `/theory/{category}/{page}`
6. Бачить контент з text blocks, приклади, таблиці
7. Бачить пов'язані тести внизу сторінки

### Задіяні файли
| Тип | Файл |
|-----|------|
| Controller | `app/Http/Controllers/TheoryController.php` |
| Controller | `app/Http/Controllers/PageController.php` (базовий) |
| Model | `app/Models/PageCategory.php` |
| Model | `app/Models/Page.php` |
| Model | `app/Models/TextBlock.php` |
| Model | `app/Models/Tag.php` |
| View | `resources/views/engram/theory/index.blade.php` |
| View | `resources/views/engram/theory/category.blade.php` |
| View | `resources/views/engram/theory/show-v3.blade.php` |
| Service | `app/Services/AutoGeneratedTestService.php` |

### Локалізація контенту
```php
// Вибір блоків за мовою
$blocks = $page->textBlocks
    ->where('locale', $preferredLocale)
    ->sortBy('sort_order');
```

---

## 4. Words Trainer → Сесія тренування

### Кроки користувача
1. Користувач відкриває `/words/test` (або medium/hard)
2. Якщо потрібно — вибирає мову навчання (UK/PL)
3. Бачить слово англійською
4. Вибирає переклад з варіантів (easy) або вводить (hard)
5. JS перевіряє відповідь
6. Показується результат + наступне слово
7. При 3 помилках — тест закінчується (failed)
8. При завершенні всіх слів — success + статистика

### Задіяні файли
| Тип | Файл |
|-----|------|
| Controller | `app/Http/Controllers/WordsTestController.php` |
| Model | `app/Models/Word.php` |
| Model | `app/Models/Translate.php` |
| View | `resources/views/words/test.blade.php` |
| Module | `app/Modules/LanguageManager/Services/LocaleService.php` |

### Особливості
- **Session-based progress** — черга слів у сесії
- **Difficulty levels**: easy (вибір), medium (case-insensitive), hard (exact match)
- **Study language selection** — UK або PL (не English)
- **3 strikes = fail** — максимум 3 помилки

### Endpoints
```
GET  /words/test/state  → поточний стан (JSON)
POST /words/test/check  → перевірка відповіді
POST /words/test/reset  → скидання прогресу
POST /words/test/set-study-language → вибір мови
```

---

## 5. Verbs Trainer → Практика

### Кроки користувача
1. Користувач відкриває `/verbs/test`
2. Бачить таблицю неправильних дієслів
3. JS генерує quiz з заповненням форм
4. Користувач вводить форми (V2, V3)
5. JS перевіряє правильність
6. Показує правильні відповіді

### Задіяні файли
| Тип | Файл |
|-----|------|
| Controller | `app/Http/Controllers/IrregularVerbsTestController.php` |
| Service | `app/Services/IrregularVerbsService.php` |
| Model | `app/Models/Word.php` (type: base/past/participle) |
| View | `resources/views/verbs/test.blade.php` |

### Форми дієслів
- **base** — інфінітив (go)
- **f1** — 3rd person singular (goes) — генерується автоматично
- **f2** — past simple (went) — з БД
- **f3** — past participle (gone) — з БД
- **f4** — present participle (going) — генерується автоматично

---

## 6. AI-підказки — Коли/Де/Обмеження

### Коли з'являються
1. Під час проходження тесту (`/test/{slug}`)
2. Після неправильної відповіді
3. Користувач натискає "Підказка" або "Пояснення"

### Типи AI-підказок
| Тип | Endpoint | Провайдер | Призначення |
|-----|----------|-----------|-------------|
| Hint | `/admin/question-hint` | ChatGPT + Gemini | Підказка структури речення |
| Explain | `/admin/question-explain` | ChatGPT | Пояснення чому відповідь неправильна |
| Marker Theory | `/admin/question-marker-theory` | Local | Теоретичний блок для маркера |

### Задіяні файли
| Тип | Файл |
|-----|------|
| Controller | `app/Http/Controllers/QuestionHelpController.php` |
| Service | `app/Services/ChatGPTService.php` |
| Service | `app/Services/GeminiService.php` |
| Model | `app/Models/QuestionHint.php` |
| Model | `app/Models/ChatGPTExplanation.php` |

### Кешування
- **QuestionHint** — зберігає підказки по question_id + provider + locale
- **ChatGPTExplanation** — зберігає пояснення по question + wrong_answer + correct_answer + language

### Обмеження/Квоти
- Немає явних rate limits у коді
- Залежить від API ключів (OpenAI/Gemini quotas)
- Кешування зменшує кількість запитів до API

### Конфігурація
```php
// config/services.php
'openai' => [
    'key' => env('OPENAI_API_KEY'),
    'model' => env('OPENAI_MODEL', 'gpt-4o-mini'),
    'timeout' => env('OPENAI_TIMEOUT', 60),
],
'gemini' => [
    'key' => env('GEMINI_API_KEY'),
    'model' => env('GEMINI_MODEL', 'gemini-2.5-flash'),
],
```

---

## 7. Admin/Teacher workflow: Створення контенту

### Кроки (створення тесту)
1. Адмін логіниться через `/login`
2. Відкриває `/admin/grammar-test`
3. Вибирає теги/категорії для генерації
4. ChatGPT генерує питання
5. Адмін редагує/видаляє питання
6. Натискає "Зберегти тест"
7. Тест з'являється в каталозі

### Кроки (управління сідерами)
1. Адмін відкриває `/admin/seed-runs`
2. Бачить дерево сідер-файлів
3. Вибирає сідер для запуску
4. Натискає "Run" → виконується сідер
5. Питання додаються до БД

### Кроки (управління тегами)
1. Адмін відкриває `/admin/test-tags`
2. Бачить список тегів
3. Може об'єднувати теги (aggregations)
4. Може використовувати ChatGPT для автоагрегації

### Задіяні файли
| Тип | Файл |
|-----|------|
| Controller | `app/Http/Controllers/GrammarTestController.php` |
| Controller | `app/Http/Controllers/SeedRunController.php` |
| Controller | `app/Http/Controllers/TestTagController.php` |
| Service | `app/Services/TagAggregationService.php` |
| View | `resources/views/seed-runs/` |
| View | `resources/views/test-tags/` |
