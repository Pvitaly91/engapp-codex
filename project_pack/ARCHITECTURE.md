# ARCHITECTURE.md — Архітектура Gramlyze

## Високорівнева схема компонентів

```mermaid
graph TB
    subgraph "Frontend"
        Browser[Browser/Client]
        Vite[Vite Dev Server]
        TW[Tailwind CSS]
    end

    subgraph "Laravel Application"
        Web[Web Routes]
        Admin[Admin Routes]
        API[API Routes]
        
        subgraph "Controllers"
            TC[TestJsV2Controller]
            ThC[TheoryController]
            WTC[WordsTestController]
            IVC[IrregularVerbsController]
            SC[SiteSearchController]
            QHC[QuestionHelpController]
        end
        
        subgraph "Services"
            ChatGPT[ChatGPTService]
            Gemini[GeminiService]
            IVS[IrregularVerbsService]
            AGT[AutoGeneratedTestService]
        end
        
        subgraph "Modules"
            LM[LanguageManager]
            PM[PageManager]
            GD[GitDeployment]
        end
    end

    subgraph "Data Layer"
        MySQL[(MySQL Database)]
        FileCache[File Cache]
        Session[Session Storage]
    end

    subgraph "External Services"
        OpenAI[OpenAI API]
        GeminiAPI[Google Gemini API]
    end

    Browser --> Web
    Browser --> Admin
    Browser --> API
    
    Web --> TC & ThC & WTC & IVC & SC
    Admin --> QHC
    
    TC --> MySQL
    ThC --> MySQL
    WTC --> MySQL
    IVC --> IVS
    QHC --> ChatGPT & Gemini
    
    ChatGPT --> OpenAI
    Gemini --> GeminiAPI
    
    Services --> MySQL
    Services --> FileCache
```

---

## Точки входу

### Web Routes (`routes/web.php`)
Публічні маршрути для користувачів:
- `/` — головна сторінка
- `/pages`, `/theory` — теоретичні матеріали
- `/test/{slug}` — граматичні тести (різні режими)
- `/words/test` — тренажер слів
- `/verbs/test` — тренажер дієслів
- `/search` — глобальний пошук
- `/catalog/tests-cards` — каталог тестів

### Admin Routes (`routes/admin.php`)
Маршрути для адміністраторів (захищені middleware `auth.admin`):
- `/admin/` — дашборд
- `/admin/test-tags/` — управління тегами
- `/admin/grammar-test` — генерація тестів
- `/admin/seed-runs` — управління сідерами
- `/admin/site-tree` — управління структурою сайту
- `/admin/words/export` — експорт/імпорт слів

### API Routes (`routes/api.php`)
- `/api/search` — пошук слів (autocomplete)
- `/api/user` — інформація про користувача (Sanctum)

### Console Commands (`routes/console.php`)
- `inspire` — демо команда
- Немає кастомних scheduled tasks (в поточній версії)

---

## Основні доменні модулі

### 1. Catalog (Каталог тестів)
**Файли:**
- `app/Http/Controllers/GrammarTestController.php`
- `app/Models/SavedGrammarTest.php`
- `app/Models/SavedGrammarTestQuestion.php`
- `resources/views/saved-tests.blade.php`

**Функціонал:**
- Відображення списку тестів картками
- Фільтрація за тегами/категоріями

### 2. Theory (Теорія)
**Файли:**
- `app/Http/Controllers/TheoryController.php`
- `app/Http/Controllers/PageController.php`
- `app/Models/Page.php`
- `app/Models/PageCategory.php`
- `app/Models/TextBlock.php`
- `resources/views/engram/theory/`

**Функціонал:**
- Ієрархія категорій та сторінок
- Блоки контенту з локалізацією
- Пов'язані тести на основі тегів

### 3. Words Trainer (Тренажер слів)
**Файли:**
- `app/Http/Controllers/WordsTestController.php`
- `app/Models/Word.php`
- `app/Models/Translate.php`
- `resources/views/words/test.blade.php`

**Функціонал:**
- Три рівні складності (easy, medium, hard)
- Вибір мови навчання (UK, PL)
- Відстеження прогресу в сесії

### 4. Verbs Trainer (Тренажер дієслів)
**Файли:**
- `app/Http/Controllers/IrregularVerbsTestController.php`
- `app/Services/IrregularVerbsService.php`
- `resources/views/verbs/test.blade.php`

**Функціонал:**
- База неправильних дієслів (base, past, participle)
- Автогенерація форм -s, -ing

### 5. Search (Пошук)
**Файли:**
- `app/Http/Controllers/SiteSearchController.php`
- `app/Http/Controllers/WordSearchController.php`
- `resources/views/search/results.blade.php`

**Функціонал:**
- Пошук по сторінках теорії
- Пошук по тестах
- Autocomplete для слів

### 6. AI Hints (AI-підказки)
**Файли:**
- `app/Http/Controllers/QuestionHelpController.php`
- `app/Services/ChatGPTService.php`
- `app/Services/GeminiService.php`
- `app/Models/QuestionHint.php`
- `app/Models/ChatGPTExplanation.php`

**Функціонал:**
- Пояснення неправильних відповідей
- Підказки щодо структури речення
- Визначення рівня CEFR
- Кешування відповідей у БД

### 7. Admin/Content Management
**Файли:**
- `app/Http/Controllers/SeedRunController.php`
- `app/Http/Controllers/TestTagController.php`
- `app/Http/Controllers/SiteTreeController.php`
- `app/Modules/GitDeployment/`

**Функціонал:**
- Запуск сідерів через UI
- Управління тегами та агрегаціями
- Структура дерева сайту
- GitHub деплоймент

---

## Sequence Diagram: Запуск тесту + AI-підказка

```mermaid
sequenceDiagram
    participant U as User
    participant B as Browser
    participant TC as TestJsV2Controller
    participant DB as Database
    participant QHC as QuestionHelpController
    participant GPT as ChatGPTService
    participant AI as OpenAI API

    U->>B: Відкриває /test/{slug}
    B->>TC: GET /test/{slug}
    TC->>DB: Завантажує SavedGrammarTest
    TC->>DB: Завантажує Questions з answers, options
    TC-->>B: Рендерить Blade view з JS data
    
    B->>B: JavaScript ініціалізує тест
    
    U->>B: Вводить відповідь (неправильну)
    B->>B: JS перевіряє відповідь локально
    B-->>U: Показує "Неправильно"
    
    U->>B: Натискає "Пояснення"
    B->>QHC: POST /question-explain
    QHC->>DB: Шукає кешоване пояснення
    
    alt Кеш знайдено
        QHC-->>B: Повертає кешоване пояснення
    else Кеш не знайдено
        QHC->>GPT: explainWrongAnswer()
        GPT->>AI: HTTP POST (chat/completions)
        AI-->>GPT: Відповідь з поясненням
        GPT->>DB: Зберігає в ChatGPTExplanation
        GPT-->>QHC: Текст пояснення
        QHC-->>B: JSON response
    end
    
    B-->>U: Показує пояснення в UI
```

---

## Sequence Diagram: Глобальний пошук → Теорія

```mermaid
sequenceDiagram
    participant U as User
    participant B as Browser
    participant SC as SiteSearchController
    participant DB as Database
    participant ThC as TheoryController

    U->>B: Вводить текст у пошук
    B->>SC: GET /search?q={query}
    
    SC->>DB: SELECT FROM pages WHERE title LIKE '%query%'
    SC->>DB: SELECT FROM tests WHERE name LIKE '%query%'
    
    SC-->>B: JSON [{title, type, url}, ...]
    B-->>U: Показує dropdown з результатами
    
    U->>B: Клікає на результат (теорія)
    B->>ThC: GET /theory/{category}/{page}
    ThC->>DB: Завантажує Page з textBlocks, tags
    ThC->>DB: Завантажує related tests
    ThC-->>B: Рендерить theory.show view
    B-->>U: Показує сторінку теорії
```
